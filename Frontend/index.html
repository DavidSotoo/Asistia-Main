<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control de Asistencia por QR</title>
  <link rel="stylesheet" href="style.css" />
  <!-- jsQR (librería para decodificar QR desde ImageData) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" defer></script>
  <script src="script.js" defer></script>
</head>
<body>
  <!-- Librería QRCode.js para generar QR (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Script para generar QR -->
    <script src="generarQR.js"></script>
    <!-- Audio element for success sound -->
    <audio id="successSound" preload="auto">
      <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
      Your browser does not support the audio element.
    </audio>
  <!-- Login Form -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="8" r="3" stroke="var(--accent)" stroke-width="2" fill="var(--accent2)" opacity="0.8"/>
            <path d="M12 14c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4z" stroke="var(--accent)" stroke-width="2" fill="var(--accent2)" opacity="0.8"/>
          </svg>
        </div>
        <h1>Control de Asistia</h1>
        <p class="login-subtitle">Inicia sesión para acceder al sistema</p>
      </div>
      
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="username" class="form-label">Usuario</label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            class="form-input" 
            placeholder="Ingresa tu usuario"
            required
            autocomplete="username"
          >
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">Contraseña</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            class="form-input" 
            placeholder="Ingresa tu contraseña"
            required
            autocomplete="current-password"
          >
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">
          <span class="btn-text">Iniciar Sesión</span>
          <span class="btn-loading" style="display: none;">Iniciando...</span>
        </button>
        
        <div id="loginError" class="error-message" style="display: none;"></div>
      </form>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <main class="container" id="mainApp" style="display: none;">
    <!-- Pantalla de menú principal -->
    <section id="menuPrincipal" class="menu-principal">
      <h1 class="menu-title">¿Qué deseas hacer?</h1>
      <div class="menu-btns">
        <button id="btnIrEscanear" class="menu-btn-grande">Escanear QR</button>
        <button id="btnIrGenerar" class="menu-btn-grande">Generar QR</button>
        <button id="btnIrLista" class="menu-btn-grande">Lista</button>
        <button id="btnIrAlumnos" class="menu-btn-grande">Alumnos</button>
        <!-- Botón para crear maestros (solo visible para admin) -->
        <button id="btnCrearMaestro" class="menu-btn-grande admin-only" style="display:none;">Crear Maestro</button>
        <!-- Botón para gestionar materias (solo visible para admin) -->
        <button id="btnGestionarMaterias" class="menu-btn-grande admin-only" style="display:none;">Gestionar Materias</button>
      </div>
      <button id="logoutBtn" class="logout-btn" title="Cerrar sesión" style="margin-top:40px;">Cerrar Sesión</button>
    </section>

    <!-- Menú específico para maestros -->
    <section id="menuMaestro" class="menu-principal" style="display:none;">
      <h1 class="menu-title">Panel del Maestro</h1>
      <div class="menu-btns">
        <button id="btnMaestroEscanear" class="menu-btn-grande">Escanear QR</button>
        <button id="btnMaestroGenerar" class="menu-btn-grande">Generar QR</button>
        <button id="btnMaestroLista" class="menu-btn-grande">Ver Asistencias</button>
        <button id="btnMaestroAlumnos" class="menu-btn-grande">Alumnos</button>
      </div>
      <button id="logoutBtnMaestro" class="logout-btn" title="Cerrar sesión" style="margin-top:40px;">Cerrar Sesión</button>
    </section>

    <!-- Sección Escanear QR (inicialmente oculta) -->
    <section id="seccionEscanear" style="display:none;">
      <header class="header">
        <div class="header-content">
          <div>
            <h1>Control de Asistencia — Escaneo QR</h1>
            <p class="sub">Muestra tu código QR al lente. Compatible desktop y móvil.</p>
          </div>
        </div>
      </header>
      <div class="scanner">
        <div class="video-wrap">
          <video id="video" playsinline autoplay muted></video>
          <div class="overlay">
            <div class="frame"></div>
          </div>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn">Iniciar cámara</button>
          <button id="stopBtn" class="btn btn-secondary" disabled>Detener cámara</button>
          <div class="switch-torch">
            <input type="checkbox" id="torchSwitch">
            <label for="torchSwitch" class="switch-torch-label"></label>
            <span class="switch-torch-text">Linterna (si está disponible)</span>
          </div>
        </div>
      </div>
      <aside class="results" aria-live="polite">
        <h2>Resultado</h2>
        <div id="resultCard" class="card empty">
          <p class="hint">Aún no se ha escaneado ningún QR.</p>
        </div>
        <div class="history">
          <h3>Historial reciente</h3>
          <ul id="historyList"></ul>
        </div>
      </aside>
      <canvas id="canvas" hidden></canvas>
      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuEscanear" class="volver-menu-btn">Volver al menú principal</button>
      </div>
      <footer class="footer">
        <small>Asistia</small>
      </footer>
    </section>

    <!-- Sección Generar QR (inicialmente oculta) -->
    <section id="seccionGenerar" style="display:none;">
      <h1>Generar QR para Alumno</h1>
      <div class="qr-form-container">
        <div class="qr-form-card">
          <form id="formAlumno">
            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" required>
            <label for="apellido">Apellido</label>
            <input type="text" id="apellido" required>
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" required>
            <label for="grupo">Grupo</label>
            <input type="text" id="grupo" required>

            <!-- Sección de captura de foto -->
            <div class="photo-capture-section">
              <label>Foto del Alumno</label>
              <div class="camera-controls">
                <video id="photoVideo" playsinline autoplay muted style="width: 100%; max-width: 300px; border: 1px solid #ccc;"></video>
                <canvas id="photoCanvas" hidden></canvas>
                <div class="photo-buttons">
                  <button type="button" id="startPhotoCamera" class="btn btn-secondary">Iniciar Cámara</button>
                  <button type="button" id="capturePhoto" class="btn btn-secondary" disabled>Capturar Foto</button>
                  <button type="button" id="retakePhoto" class="btn btn-secondary" style="display: none;">Tomar Otra</button>
                </div>
                <div id="photoPreview" class="photo-preview" style="display: none;">
                  <img id="capturedPhoto" alt="Foto capturada" style="width: 100%; max-width: 300px;">
                </div>
              </div>
            </div>

            <button type="submit">Generar QR</button>
          </form>
          <div id="mensaje" class="mensaje"></div>
        </div>
        <div class="qr-result-card">
          <div id="resultado" class="resultado">
            <div class="qr-display">
              <img id="qrImagen" src="placeholderQR.svg" alt="QR del alumno">
            </div>
            <div class="qr-buttons">
              <a id="descargarQR" class="btn" href="" download="alumno_qr.png" hidden>Descargar QR</a>
              <button id="generarNuevoQR" class="btn" hidden>Nuevo QR</button>
              <button id="btnVolverMenuGenerar" class="btn">Volver al menú</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sección Lista de Asistencias (inicialmente oculta) -->
    <section id="seccionListado" style="display:none;">
      <h1>Lista de Asistencias</h1>
      <div class="attendance-list-container">
        <div class="table-actions">
          <button id="exportCsvBtn" class="btn">Exportar a CSV</button>
        </div>
        <div class="attendance-stats">
          <div class="stat-card">
            <span class="stat-number" id="totalAlumnos">0</span>
            <span class="stat-label">Total Alumnos</span>
          </div>
          <div class="stat-card">
            <span class="stat-number" id="totalPresentes">0</span>
            <span class="stat-label">Presentes</span>
          </div>
          <div class="stat-card">
            <span class="stat-number" id="totalAusentes">0</span>
            <span class="stat-label">Ausentes</span>
          </div>
          <div class="stat-card">
            <span class="stat-number" id="totalTarde">0</span>
            <span class="stat-label">Tarde</span>
          </div>
        </div>
        <div class="attendance-table-container">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Estado</th>
                <th>Última Actualización</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <!-- Los datos se cargarán dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuListado" class="volver-menu-btn">Volver al menú principal</button>
      </div>
    </section>

    <!-- Sección Lista de Alumnos (inicialmente oculta) -->
    <section id="seccionAlumnos" style="display:none;">
      <h1>Lista de Alumnos</h1>
      <div class="students-list-container">
        <div class="students-cards-container" id="studentsCardsContainer">
          <!-- Las tarjetas de alumnos se cargarán dinámicamente -->
        </div>
      </div>
      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuAlumnos" class="volver-menu-btn">Volver al menú principal</button>
      </div>
    </section>

    <!-- Sección Crear Maestro (inicialmente oculta) -->
    <section id="seccionCrearMaestro" style="display:none;">
      <h1>Crear Nuevo Maestro</h1>
      <div class="teacher-form-container">
        <div class="teacher-form-card">
          <form id="formCrearMaestro">
            <div class="form-group">
              <label for="maestroUsername">Nombre de Usuario</label>
              <input type="text" id="maestroUsername" name="username" required placeholder="Ingresa el nombre de usuario">
            </div>

            <div class="form-group">
              <label for="maestroPassword">Contraseña</label>
              <input type="password" id="maestroPassword" name="password" required placeholder="Ingresa la contraseña">
            </div>

            <div class="form-group">
              <label for="maestroName">Nombre Completo</label>
              <input type="text" id="maestroName" name="name" required placeholder="Ingresa el nombre completo">
            </div>

            <div class="form-group">
              <label for="maestroEmail">Email (Opcional)</label>
              <input type="email" id="maestroEmail" name="email" placeholder="Ingresa el email">
            </div>

            <button type="submit" class="btn btn-primary">Crear Maestro</button>
          </form>
        </div>

        <div class="teachers-list-container">
          <h2>Lista de Maestros</h2>
          <div id="teachersList" class="teachers-list">
            <!-- Los maestros se cargarán dinámicamente -->
          </div>
        </div>
      </div>

      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuCrearMaestro" class="volver-menu-btn">Volver al menú principal</button>
      </div>
    </section>

    <!-- Sección Gestionar Materias (inicialmente oculta) -->
    <section id="seccionGestionarMaterias" style="display:none;">
      <h1>Gestión de Materias</h1>
      <div class="subjects-container">
        <div class="subjects-form-container">
          <div class="subjects-form-card">
            <h2 id="formTitle">Crear Nueva Materia</h2>
            <form id="formMateria">
              <input type="hidden" id="materiaId" name="id">
              
              <div class="form-group">
                <label for="materiaNombre">Nombre de la Materia *</label>
                <input type="text" id="materiaNombre" name="name" required placeholder="Ej: Matemáticas I">
              </div>

              <div class="form-group">
                <label for="materiaCodigo">Código (Opcional)</label>
                <input type="text" id="materiaCodigo" name="code" placeholder="Ej: MAT101">
              </div>

              <div class="form-group">
                <label for="materiaDescripcion">Descripción (Opcional)</label>
                <textarea id="materiaDescripcion" name="description" rows="3" placeholder="Descripción de la materia"></textarea>
              </div>

              <div class="form-group">
                <label for="materiaMaestro">Maestro *</label>
                <select id="materiaMaestro" name="teacherId" required>
                  <option value="">Selecciona un maestro</option>
                </select>
              </div>

              <div class="form-group">
                <label>Horarios</label>
                <div id="horariosContainer">
                  <!-- Los horarios se agregarán dinámicamente -->
                </div>
                <button type="button" id="btnAgregarHorario" class="btn btn-secondary">+ Agregar Horario</button>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="btnGuardarMateria">Guardar Materia</button>
                <button type="button" class="btn btn-secondary" id="btnCancelarMateria" style="display:none;">Cancelar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="subjects-list-container">
          <h2>Lista de Materias</h2>
          <div id="subjectsList" class="subjects-list">
            <!-- Las materias se cargarán dinámicamente -->
          </div>
        </div>
      </div>

      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuMaterias" class="volver-menu-btn">Volver al menú principal</button>
      </div>
    </section>

  </main>
</body>
</html>
