<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control de Asistencia por QR</title>
  <link rel="stylesheet" href="style.css" />
  <!-- jsQR (librería para decodificar QR desde ImageData) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" defer></script>
  <script src="script.js" defer></script>
</head>
<body>
    <!-- Librería QRCode.js para generar QR (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Script para generar QR -->
    <script src="generarQR.js"></script>
  <!-- Login Form -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1>Control de Asistia</h1>
        <p class="login-subtitle">Inicia sesión para acceder al sistema</p>
      </div>
      
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="username" class="form-label">Usuario</label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            class="form-input" 
            placeholder="Ingresa tu usuario"
            required
            autocomplete="username"
          >
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">Contraseña</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            class="form-input" 
            placeholder="Ingresa tu contraseña"
            required
            autocomplete="current-password"
          >
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">
          <span class="btn-text">Iniciar Sesión</span>
          <span class="btn-loading" style="display: none;">Iniciando...</span>
        </button>
        
        <div id="loginError" class="error-message" style="display: none;"></div>
      </form>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <main class="container" id="mainApp" style="display: none;">
    <!-- Pantalla de menú principal -->
    <section id="menuPrincipal" class="menu-principal">
      <h1 class="menu-title">¿Qué deseas hacer?</h1>
      <div class="menu-btns">
        <button id="btnIrEscanear" class="menu-btn-grande">Escanear QR</button>
        <button id="btnIrGenerar" class="menu-btn-grande">Generar QR</button>
        <button id="btnIrLista" class="menu-btn-grande">Lista de Asistencia</button>
      </div>
      <button id="logoutBtn" class="logout-btn" title="Cerrar sesión" style="margin-top:40px;">Cerrar Sesión</button>
    </section>

    <!-- Sección Escanear QR (inicialmente oculta) -->
    <section id="seccionEscanear" style="display:none;">
      <header class="header">
        <div class="header-content">
          <div>
            <h1>Control de Asistencia — Escaneo QR</h1>
            <p class="sub">Muestra tu código QR al lente. Compatible desktop y móvil.</p>
          </div>
        </div>
      </header>
      <div class="scanner">
        <div class="video-wrap">
          <video id="video" playsinline autoplay muted></video>
          <div class="overlay">
            <div class="frame"></div>
          </div>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn">Iniciar cámara</button>
          <button id="stopBtn" class="btn btn-secondary" disabled>Detener cámara</button>
          <div class="switch-torch">
            <input type="checkbox" id="torchSwitch">
            <label for="torchSwitch" class="switch-torch-label"></label>
            <span class="switch-torch-text">Linterna (si está disponible)</span>
          </div>
        </div>
      </div>
      <aside class="results" aria-live="polite">
        <h2>Resultado</h2>
        <div id="resultCard" class="card empty">
          <p class="hint">Aún no se ha escaneado ningún QR.</p>
        </div>
        <div class="history">
          <h3>Historial reciente</h3>
          <ul id="historyList"></ul>
        </div>
      </aside>
      <canvas id="canvas" hidden></canvas>
      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuEscanear" class="volver-menu-btn">Volver al menú principal</button>
      </div>
      <footer class="footer">
        <small>Asistia</small>
      </footer>
    </section>

    <!-- Sección Generar QR (inicialmente oculta) -->
    <section id="seccionGenerar" style="display:none;">
      <div class="qr-form-container">
        <h1>Generar QR para Alumno</h1>
        <div class="qr-form-card">
          <form id="formAlumno">
            <label for="nombre">Nombre completo</label>
            <input type="text" id="nombre" required>
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" required>
            <label for="grupo">Grupo</label>
            <input type="text" id="grupo" required>
            <button type="submit">Generar QR</button>
          </form>
        </div>
        <div class="qr-result-card">
          <div id="resultado" class="resultado">
            <h2>Código QR generado</h2>
            <img id="qrImagen" src="" alt="QR del alumno" hidden>
            <a id="descargarQR" class="btn" href="" download="alumno_qr.png" hidden>Descargar QR</a>
            <button id="generarNuevoQR" class="btn" hidden>Generar Nuevo QR</button>
          </div>

        </div>
      <div style="text-align:center; margin: 32px 0 0 0;">
        <button id="btnVolverMenuGenerar" class="volver-menu-btn">Volver al menú principal</button>
      </div>
    <!-- Sección Lista de Asistencia (inicialmente oculta) -->
    <section id="seccionLista" style="display:none;">
      <div class="attendance-list-container">
        <h1>Lista de Asistencia</h1>
        <div class="stats-summary">
          <div class="stat-card">
            <h3>Total Alumnos</h3>
            <span id="totalAlumnos">-</span>
          </div>
          <div class="stat-card">
            <h3>Presentes</h3>
            <span id="totalPresentes">-</span>
          </div>
          <div class="stat-card">
            <h3>Ausentes</h3>
            <span id="totalAusentes">-</span>
          </div>
          <div class="stat-card">
            <h3>Tarde</h3>
            <span id="totalTarde">-</span>
          </div>
        </div>
        <div class="attendance-table-container">
          <table id="attendanceTable" class="attendance-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Estado</th>
                <th>Última Actualización</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <!-- Los datos se cargarán dinámicamente -->
            </tbody>
          </table>
        </div>
        <div style="text-align:center; margin: 32px 0 0 0;">
          <button id="btnVolverMenuLista" class="volver-menu-btn">Volver al menú principal</button>
        </div>
      </div>
    </section>
  </main>
</body>
</html>
